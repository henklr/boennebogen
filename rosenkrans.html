<!DOCTYPE html>
<html lang="da">
<head>
  <link rel="icon" href="favicon.png" type="image/png">
  <link rel="apple-touch-icon" href="/icon.jpg">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rosenkransen</title>
  <meta name="theme-color" content="#0f172a">
  <link rel="stylesheet" href="style.css">
  <link rel="preload" href="bg-main-menu.jpg" as="image">
  <link rel="preload" href="bg-ortodoks-morgen.jpg" as="image">
  <link rel="preload" href="bg-ortodoks-aften.jpg" as="image">
  <link rel="preload" href="bg-joyful.jpg" as="image">
  <link rel="preload" href="bg-luminous.jpg" as="image">
  <link rel="preload" href="bg-sorrowful.jpg" as="image">
  <link rel="preload" href="bg-glorious.jpg" as="image">
  <script src="prayers.js"></script>

  <!-- Inline helper CSS for the fixed/scrollable overview (move to style.css if you prefer) -->
  <style>
    .card details[open] #overview{
      height: clamp(240px, 40vh, 420px);
      overflow-y: auto;
      overscroll-behavior: contain;
      padding-right: 6px;
      scroll-behavior: smooth;
      border-radius: 10px;
      -webkit-overflow-scrolling: touch;
    }
  </style>
</head>
<body class="rosenkrans">
  <div class="bg"></div>
  <header>
    <div class="inner">
      <a href="/" class="home-btn" aria-label="Hjem" title="Tilbage til forsiden">◀</a>
      <div class="row">
        <label class="pill" title="Vælg version">
          <select id="versionSelect" aria-label="Vælg version">
            <option value="false">Lang</option>
            <option value="true">Kort</option>
          </select>
        </label>
        <label class="pill" title="Vælg dag">
          <select id="daySelect" aria-label="Vælg dag">
            <option value="0">Søndag</option>
            <option value="1">Mandag</option>
            <option value="2">Tirsdag</option>
            <option value="3">Onsdag</option>
            <option value="4">Torsdag</option>
            <option value="5">Fredag</option>
            <option value="6">Lørdag</option>
          </select>
        </label>
      </div>
    </div>
  </header>

  <main class="app">
    <section class="grid">
      <div class="card">
        <div class="kicker">Aktuelle mysterier</div>
        <h2 id="mysteryTitle">Lysets mysterier</h2>
        <div class="muted" id="mysterySubtitle">Bedes normalt torsdag</div>
        <div class="progress" aria-label="Fremskridt"><div id="progressFill" style="width: 2.9%;"></div></div>
      </div>

      <div class="card" id="currentCard">
        <div class="kicker" id="currentKind">Intro</div>
        <div id="currentTitle" class="big" style="margin:6px 0 8px">Korsets tegn</div>
        <div id="currentBody">I Faderens og Sønnens og Helligåndens navn. Amen.</div>
      </div>

      <div class="card">
        <!-- added id here -->
        <details id="overviewDetails">
          <summary><strong>Oversigt</strong> – hele forløbet for i dag</summary>
          <div id="overview" class="list" style="margin-top:10px"></div>
        </details>
      </div>

      <div class="card">
        <details>
          <summary><strong>Hjælp</strong> – sådan beder du rosenkransen</summary>
          <ol>
            <li>Korsets tegn → Trosbekendelsen.</li>
            <li>1× Fadervor, 3× Ave Maria (tro, håb, kærlighed), 1× Ære være Faderen.</li>
            <li>For hvert mysterium (5 i alt): bekræft mysteriet, 1× Fadervor, 10× Ave Maria, 1× Ære være Faderen, <em>O min Jesus</em>.</li>
            <li>Afslut: Hil Dig Dronning (Salve Regina) + afslutningsbøn + korsets tegn.</li>
          </ol>
        </details>
      </div>
    </section>
  </main>

  <nav class="actions" aria-label="Kontroller">
    <div class="bar">
      <button id="restartBtn" class="btn" aria-label="Genstart">↺ Genstart</button>
      <button id="prevBtn" class="btn" aria-label="Forrige" disabled>◀ Forrige</button>
      <button id="nextBtn" class="btn primary" aria-label="Næste">Næste ▶</button>
    </div>
  </nav>

  <script>
    // Mysterier (DA) med traditionelle forklaringer og Ave Maria-tilføjelser
    const MYSTERIES = {
      Joyful: {
        name: "Glædens mysterier",
        subtitle: "Bedes normalt mandag og lørdag",
        image: "bg-joyful.jpg",
        items: [
          {
            title: "Bebudelsen (Englen besøger Maria)",
            body: "Vi betænker, hvordan englen Gabriel bebuder Maria, at hun skal blive Guds Moder, og hun svarer ydmygt: 'Se, jeg er Herrens tjenerinde; det ske mig efter dit ord.' (Luk 1,38). Lad os bede om ydmyghed og lydighed mod Guds vilje.",
            aveClause: "som Du undfangede ved Helligånden"
          },
          {
            title: "Visitationsmysteriet (Maria besøger Elisabeth)",
            body: "Vi betænker, hvordan Maria besøger sin kusine Elisabeth, og ved deres møde fyldes Elisabeth af Helligånden og priser Maria. Maria synger Magnificat. Lad os bede om næstekærlighed og glæde i tjeneste for andre.",
            aveClause: "som Du bar ved dit besøg hos Elisabeth"
          },
          {
            title: "Jesu fødsel i Betlehem",
            body: "Vi betænker, hvordan Jesus fødes i en stald i Betlehem, og Maria og Josef tager imod ham i fattigdom og kærlighed. Englene synger: 'Ære være Gud i det højeste!' Lad os bede om fattigdom i ånden og glæde over Kristi komme.",
            aveClause: "som Du fødte i stalden i Betlehem"
          },
          {
            title: "Fremstillingen af Jesus i templet",
            body: "Vi betænker, hvordan Maria og Josef bringer Jesus til templet for at fremstille ham for Herren, og Simeon priser ham som verdens lys. Lad os bede om lydighed mod Guds lov og hengivenhed til Kristus.",
            aveClause: "som Du ofrede i templet"
          },
          {
            title: "Jesus, tolv år, i templet",
            body: "Vi betænker, hvordan Jesus som tolvårig bliver i templet for at tale om sin Fader, og Maria og Josef finder ham efter tre dage. Lad os bede om visdom og iver efter Guds rige.",
            aveClause: "som Du genfandt i templet"
          }
        ]
      },
      Luminous: {
        name: "Lysets mysterier",
        subtitle: "Bedes normalt torsdag",
        image: "bg-luminous.jpg",
        items: [
          {
            title: "Jesu dåb i Jordan",
            body: "Vi betænker, hvordan Jesus døbes af Johannes i Jordanfloden, og Helligånden kommer over ham, mens Faderens stemme siger: 'Du er min elskede Søn.' (Matt 3,17). Lad os bede om åbenhed for Helligånden og renhed i hjertet.",
            aveClause: "som blev døbt i Jordan"
          },
          {
            title: "Brylluppet i Kana",
            body: "Vi betænker, hvordan Jesus på Marias opfordring forvandler vand til vin ved brylluppet i Kana og åbenbarer sin herlighed. Lad os bede om tillid til Marias forbøn og tro på Jesu kraft.",
            aveClause: "som forvandlede vand til vin i Kana"
          },
          {
            title: "Kundgørelsen af Guds rige",
            body: "Vi betænker, hvordan Jesus forkynder Guds rige og kalder til omvendelse: 'Omvend jer, thi Himmeriget er kommet nær!' (Matt 4,17). Lad os bede om mod til at omvende os og leve efter Guds vilje.",
            aveClause: "som forkyndte Guds rige"
          },
          {
            title: "Forklarelsen på bjerget",
            body: "Vi betænker, hvordan Jesus på bjerget åbenbarer sin guddommelige herlighed for Peter, Jakob og Johannes, og Faderens stemme siger: 'Hør ham!' (Matt 17,5). Lad os bede om styrke til at følge Kristus.",
            aveClause: "som blev forklaret på bjerget"
          },
          {
            title: "Eukaristiens indstiftelse",
            body: "Vi betænker, hvordan Jesus ved den sidste nadver indstifter Eukaristien, idet han giver os sit legeme og blod under brødets og vinens skikkelse. Lad os bede om større kærlighed til Eukaristien.",
            aveClause: "som indstiftede Eukaristien"
          }
        ]
      },
      Sorrowful: {
        name: "Smertens mysterier",
        subtitle: "Bedes normalt tirsdag og fredag",
        image: "bg-sorrowful.jpg",
        items: [
          {
            title: "Jesu angst i Getsemane have",
            body: "Vi betænker, hvordan Jesus i Getsemane beder i angst: 'Fader, hvis det er muligt, lad denne kalk gå mig forbi.' (Matt 26,39). Han accepterer Guds vilje. Lad os bede om styrke til at bære lidelse.",
            aveClause: "som svedte blod for os"
          },
          {
            title: "Piskningen ved søjlen",
            body: "Vi betænker, hvordan Jesus piskes grusomt ved søjlen og bærer smerten for vores synder. Lad os bede om bod og afholdenhed fra synd.",
            aveClause: "som blev hudstrøget for os"
          },
          {
            title: "Tornerning af Jesus",
            body: "Vi betænker, hvordan Jesus hånes med en tornekrone og tager imod spot for vores stolthed. Lad os bede om ydmyghed og tålmodighed i ydmygelser.",
            aveClause: "som blev kronet med torne for os"
          },
          {
            title: "Jesus bærer korset",
            body: "Vi betænker, hvordan Jesus bærer det tunge kors til Golgata, idet han lider for vores frelse. Lad os bede om kraft til at bære vores kors med kærlighed.",
            aveClause: "som bar det tunge kors for os"
          },
          {
            title: "Korsfæstelsen og døden",
            body: "Vi betænker, hvordan Jesus dør på korset og siger: 'Det er fuldbragt!' (Joh 19,30). Han giver sit liv for os. Lad os bede om taknemmelighed for hans offer og nåde til at dø fra synden.",
            aveClause: "som blev korsfæstet for os"
          }
        ]
      },
      Glorious: {
        name: "Herlighedens mysterier",
        subtitle: "Bedes normalt onsdag og søndag",
        image: "bg-glorious.jpg",
        items: [
          {
            title: "Opstandelsen",
            body: "Vi betænker, hvordan Jesus opstår fra de døde og sejrer over synd og død. 'Han er ikke her, han er opstanden!' (Luk 24,6). Lad os bede om tro på opstandelsen og evigt liv.",
            aveClause: "som opstod fra de døde"
          },
          {
            title: "Himmelfarten",
            body: "Vi betænker, hvordan Jesus farer op til Himlen og lover at være med os alle dage. Lad os bede om håb om Himlen og iver efter at gøre hans vilje.",
            aveClause: "som opfor til Himlen"
          },
          {
            title: "Helligåndens komme (Pinsedag)",
            body: "Vi betænker, hvordan Helligånden kommer over apostlene i form af ildtunger og giver dem kraft til at forkynde. Lad os bede om Helligåndens gaver.",
            aveClause: "som nedsendte Helligånden"
          },
          {
            title: "Marias optagelse i Himlen",
            body: "Vi betænker, hvordan Maria tages op til Himlen med sjæl og legeme som en frugt af hendes troskab. Lad os bede om renhed og hengivenhed til Gud.",
            aveClause: "som optog Dig i Himlen"
          },
          {
            title: "Marias kroning som Himlens og jordens dronning",
            body: "Vi betænker, hvordan Maria krones som Himlens dronning og beder for os. Lad os bede om hendes forbøn og en dybere kærlighed til hende.",
            aveClause: "som kronede Dig i Himlen"
          }
        ]
      }
    };

    // Hvilke mysterier pr. ugedag (0 = søndag)
    function dayToSet(d) {
      const map = {
        0: 'Glorious', // søndag
        1: 'Joyful',   // mandag
        2: 'Sorrowful',// tirsdag
        3: 'Glorious', // onsdag
        4: 'Luminous', // torsdag
        5: 'Sorrowful',// fredag
        6: 'Joyful'    // lørdag
      };
      return map[d] || 'Joyful';
    }

    // Byg hele rækken af trin for en valgt mysterierække
    function buildSequence(setKey, isSimpleVersion) {
      const set = MYSTERIES[setKey];
      const seq = [];
      // Indledning
      seq.push({ kind: 'Intro', title: prayers.signOfCross.title, body: prayers.signOfCross.body});
      seq.push({ kind: 'Intro', title: prayers.creed_apostolic.title, body: prayers.creed_apostolic.body});
      seq.push({ kind: 'Intro', title: prayers.pater.title, body: prayers.pater.body});
      // 3 Ave Maria (tro, håb, kærlighed)
      const virtues = ['som forøger vor tro', 'som styrker vort håb', 'som opflammer vor kærlighed'];
      virtues.forEach((v, i) => {
        const aveBody = isSimpleVersion ? prayers.ave.body : prayers.ave.body.replace('Jesus.', `Jesus, ${v}.`);
        seq.push({ kind: 'Intro', title: `Ave Maria (${v.split(' ').at(-1)})`, body: aveBody});
      });
      seq.push({ kind: 'Intro', title: prayers.gloria.title, body: prayers.gloria.body});

      // 5 dekader
      set.items.forEach((myst, i) => {
        seq.push({ kind: 'Mysterium', title: `${i + 1}. ${myst.title}`, body: myst.body });
        seq.push({ kind: 'Dekade', title: prayers.pater.title, body: prayers.pater.body });
        const aveBody = (isSimpleVersion ? prayers.ave.body : prayers.ave.body.replace('Jesus.', `Jesus, ${myst.aveClause}.`)) + '\n\n(Gentages 10 gange)';
        seq.push({ kind: 'Dekade', title: `Ave Maria (10 gange)`, body: aveBody });
        seq.push({ kind: 'Dekade', title: prayers.gloria.title, body: prayers.gloria.body });
        seq.push({ kind: 'Dekade', title: prayers.fatima.title, body: prayers.fatima.body });
      });

      // Afslutning
      seq.push({ kind: 'Afslutning', title: prayers.salveRegina.title, body: prayers.salveRegina.body});
      seq.push({ kind: 'Afslutning', title: prayers.closing.title, body: prayers.closing.body});
      seq.push({ kind: 'Afslutning', title: prayers.signOfCross.title, body: prayers.signOfCross.body});

      return { seq, set };
    }

    // UI state
    const state = {
      setKey: null,
      sequence: [],
      i: 0,
      isSimpleVersion: false
    };

    const els = {
      daySelect: document.getElementById('daySelect'),
      versionSelect: document.getElementById('versionSelect'),
      mysteryTitle: document.getElementById('mysteryTitle'),
      mysterySubtitle: document.getElementById('mysterySubtitle'),
      currentKind: document.getElementById('currentKind'),
      currentTitle: document.getElementById('currentTitle'),
      currentBody: document.getElementById('currentBody'),
      progressFill: document.getElementById('progressFill'),
      nextBtn: document.getElementById('nextBtn'),
      prevBtn: document.getElementById('prevBtn'),
      restartBtn: document.getElementById('restartBtn'),
      overview: document.getElementById('overview'),
      bg: document.querySelector('.bg'),
      currentCard: document.getElementById('currentCard'),
      overviewDetails: document.getElementById('overviewDetails') // <-- added
    };

    function getTodayWeekday() { // 0= søn … 6=lør
      const now = new Date();
      return now.getDay();
    }

    function selectSetForUI() {
      const sel = els.daySelect.value;
      const d = parseInt(sel, 10);
      const key = dayToSet(d);
      loadSet(key);
    }

    function loadSet(key) {
      const built = buildSequence(key, state.isSimpleVersion);
      state.setKey = key;
      state.sequence = built.seq;
      state.i = 0;
      // Header
      els.mysteryTitle.textContent = MYSTERIES[key].name;
      els.mysterySubtitle.textContent = MYSTERIES[key].subtitle;
      // Set background image
      els.bg.style.backgroundImage = `url(${MYSTERIES[key].image})`;
      // Oversigt
      renderOverview();
      // Første trin
      renderStep();
    }

    // helper: keep the active step at the top of the overview scrollbox
    function scrollOverviewToActive(behavior = 'auto') {
      const active = els.overview.querySelector('.item.active');
      if (!active) return;

      // how much breathing room you want above the active item
      const gap = 50; // px
      const padTop = parseFloat(getComputedStyle(els.overview).paddingTop) || 0;
      const targetTop = Math.max(0, active.offsetTop - padTop - gap);

      els.overview.scrollTo({ top: targetTop, behavior });
    }

    function renderOverview() {
      els.overview.innerHTML = '';
      state.sequence.forEach((s, idx) => {
        const div = document.createElement('div');
        div.className = 'item' + (idx === state.i ? ' active' : '');
        div.innerHTML = `<div class="kicker">${s.kind}</div><div> ${s.title}</div>`;
        div.addEventListener('click', () => { state.i = idx; renderStep(); });
        els.overview.appendChild(div);
      });
    }

    function logRenderStep() {
      const now = new Date().toISOString();
      const current = state.i + 1;
      const total = state.sequence.length;
      const setName = MYSTERIES[state.setKey].name;
      const stepTitle = state.sequence[state.i].title;

      console.log(`[${now}] Step ${current}/${total} – ${setName} – ${stepTitle}`);
    }

    function renderStep() {
      const s = state.sequence[state.i];
      els.currentKind.textContent = s.kind;
      els.currentTitle.textContent = s.title;
      els.currentBody.textContent = s.body;
      // Progress
      const pct = ((state.i + 1) / state.sequence.length) * 100;
      els.progressFill.style.width = pct.toFixed(1) + '%';
      // Buttons
      els.prevBtn.disabled = state.i === 0;
      els.nextBtn.textContent = (state.i === state.sequence.length - 1) ? 'Færdig ✔' : 'Næste ▶';
      // Scroll to current card only if it's below the viewport
      const headerHeight = document.querySelector('header').offsetHeight || 0;
      const extraOffset = 10;
      const cardTop = els.currentCard.getBoundingClientRect().top;
      if (cardTop < headerHeight) {
        const scrollTop = els.currentCard.getBoundingClientRect().top + window.scrollY - headerHeight - extraOffset;
        window.scrollTo({ top: scrollTop, behavior: 'smooth' });
      }
      // Re-render overview and then align it
      renderOverview();
      scrollOverviewToActive('auto');

      // <-- add the log here
      logRenderStep();
    }

    function next() { if (state.i < state.sequence.length - 1) { state.i++; renderStep(); } }
    function prev() { if (state.i > 0) { state.i--; renderStep(); } }
    function restart() { state.i = 0; renderStep(); }

    function toggleVersion() {
      state.isSimpleVersion = els.versionSelect.value === 'true';
      selectSetForUI();
    }

    function loadPrefs() {
      els.daySelect.value = getTodayWeekday();
      els.versionSelect.value = state.isSimpleVersion ? 'true' : 'false';
      selectSetForUI();
    }

    // Events
    els.nextBtn.addEventListener('click', next);
    els.prevBtn.addEventListener('click', prev);
    els.restartBtn.addEventListener('click', restart);
    els.daySelect.addEventListener('change', () => { selectSetForUI(); });
    els.versionSelect.addEventListener('change', toggleVersion);

    // When the overview <details> opens, align the active item to the top
    els.overviewDetails.addEventListener('toggle', () => {
      if (els.overviewDetails.open) {
        setTimeout(() => scrollOverviewToActive('smooth'), 0);
      }
    });

    // Gestus: tryk på teksten for næste
    document.getElementById('currentCard').addEventListener('click', () => { next(); });

    // Tastatur (space/enter/venstre/højre)
    window.addEventListener('keydown', (e) => {
      if (['INPUT', 'TEXTAREA', 'SELECT'].includes((e.target || {}).tagName)) return;
      if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') { e.preventDefault(); next(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    });

    // Init
    loadPrefs();
  </script>
<script>
  // === CONFIG (keep yours) ===
  const LOG_ENDPOINT = "/api/rosenkrans/logs";
  const LOG_BATCH_SIZE = 10;
  const LOG_FLUSH_MS  = 5000;

  // --- NEW LIMITS ---
  const MAX_STASH_ENTRIES    = 2000;       // cap localStorage backlog
  const MAX_ENTRIES_PER_POST = 50;         // small batches
  const MAX_BODY_BYTES       = 120 * 1024; // ~120KB, under nginx 256k

  // === SESSION-ID & QUEUE (keep yours) ===
  const sessionId = (crypto && crypto.randomUUID)
    ? crypto.randomUUID()
    : (Date.now().toString(36) + Math.random().toString(36).slice(2));

  const logQueue = [];
  let flushTimer = null;
  let isFlushing = false;

  function scheduleFlush() {
    if (flushTimer) return;
    flushTimer = setTimeout(flushLogs, LOG_FLUSH_MS);
  }

  // --- NEW: stash helpers ---
  function getStash() {
    try { return JSON.parse(localStorage.getItem("rosenkrans_log_stash") || "[]"); }
    catch { return []; }
  }
  function setStash(arr) {
    try {
      if (arr.length > MAX_STASH_ENTRIES) arr = arr.slice(-MAX_STASH_ENTRIES);
      localStorage.setItem("rosenkrans_log_stash", JSON.stringify(arr));
    } catch {
      // last resort: keep only the newest 200
      try { localStorage.setItem("rosenkrans_log_stash", JSON.stringify(arr.slice(-200))); } catch {}
    }
  }

  // --- NEW: build a safe chunk by count & size ---
  function buildChunk(fromArr) {
    const out = [];
    for (let i = 0; i < fromArr.length && out.length < MAX_ENTRIES_PER_POST; i++) {
      const candidate = fromArr[i];
      const tentative = JSON.stringify({ entries: out.concat([candidate]) });
      if (tentative.length > MAX_BODY_BYTES) break;
      out.push(candidate);
    }
    return out;
  }

  // === CHANGE: flush immediately (switch back later if you want batching) ===
  function enqueueLog(event) {
    try {
      logQueue.push(event);
      flushLogs().catch(err => console.error("flush error", err));
      // If you prefer batching later, use:
      // if (logQueue.length >= LOG_BATCH_SIZE) flushLogs().catch(()=>{});
      // else scheduleFlush();
    } catch {
      const stash = getStash();
      stash.push(event);
      setStash(stash);
    }
  }

  // === CHANGE: chunked flush with stash cap ===
  async function flushLogs(useBeacon = false) {
    if (isFlushing) return;
    clearTimeout(flushTimer);
    flushTimer = null;

    const stash = getStash();
    if (stash.length === 0 && logQueue.length === 0) return;

    // drain old first, then new
    const merged = stash.concat(logQueue.splice(0));
    const chunk = buildChunk(merged);
    if (chunk.length === 0) return; // defensive

    const bodyStr = JSON.stringify({ entries: chunk });
    isFlushing = true;
    try {
      if (useBeacon && navigator.sendBeacon) {
        const ok = navigator.sendBeacon(LOG_ENDPOINT, new Blob([bodyStr], { type: "application/json" }));
        if (!ok) throw new Error("sendBeacon returned false");
      } else {
        const res = await fetch(LOG_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: bodyStr,
          keepalive: true
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
      }

      // success: stash the unsent remainder
      const remaining = merged.slice(chunk.length);
      setStash(remaining);

      // if more to send, keep draining soon
      if (remaining.length > 0 || logQueue.length > 0) {
        setTimeout(() => { isFlushing = false; flushLogs().catch(()=>{}); }, 50);
        return;
      }
    } catch (err) {
      // failure: re-stash everything (capped)
      setStash(merged.concat(logQueue.splice(0)));
      console.warn("flush failed, will retry later:", err);
    } finally {
      isFlushing = false;
    }
  }
  
  // Flush when tab is hidden/closed
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState !== "visible") flushLogs(true);
  });
  window.addEventListener("pagehide", () => flushLogs(true)); // better than beforeunload on mobile

  // === BUILD & ENQUEUE ONE ENTRY ===
  function logRenderStepServer() {
    const now = new Date().toISOString();
    const current = (state?.i ?? 0) + 1;
    const total = state?.sequence?.length ?? 0;
    const setKey = state?.setKey ?? "unknown";
    const setName = (MYSTERIES?.[setKey]?.name) || setKey;
    const s = (state?.sequence?.[state?.i || 0]) || {};
    const stepTitle = s.title || "";
    const kind = s.kind || "";

    enqueueLog({
      ts: now,
      sessionId,
      setKey,
      setName,
      stepTitle,
      kind,
      step: current,
      total,
      versionSimple: !!(state?.isSimpleVersion),
      locale: navigator.language || "da",
      ua: navigator.userAgent
    });
  }

  // === PATCH renderStep so every render logs ===
  (function patchRenderStepForLogging() {
    if (typeof window.renderStep !== "function") {
      console.warn("log-init: renderStep not found yet – will retry after a tick");
      setTimeout(patchRenderStepForLogging, 0);
      return;
    }
    const originalRenderStep = window.renderStep;
    window.renderStep = function() {
      const ret = originalRenderStep.apply(this, arguments);
      console.log("log-init: renderStep fired");
      logRenderStepServer();
      return ret;
    };
    console.log("log-init: renderStep patched");

    // *** EXTRA: log the very first already-rendered step too ***
    // On initial load, your code calls renderStep() BEFORE this patch.
    // Log once now so the first step is captured.
    if (state?.sequence?.length) {
      console.log("log-init: logging initial render");
      logRenderStepServer();
    }
  })();
</script>
</body>
</html>
